#워크 플로우 이름 Action에 표시되는 이름
name: Docker Deploy to EC2
# 실행 조건. main 브랜치에 push 발생시 jobs 실행
on:
  push:
    branches:
      - main
# 실행할 기능 설정
jobs:
  deploy:
    name: Deploy to EC2 with Docker	#Job의 이름
    runs-on: ubuntu-latest	#배포 서버의 실행 환경. 우분투 최신버전
	steps:
    - name: Checkout source code
      uses: actions/checkout@v3
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    - name: Build Docker image
      run: docker build -t gdj90/shop3:${{ github.run_number }} .
    - name: Save Docker image as tar
      run: |
        docker save gdj90/shop3:${{ github.run_number }} -o shop3.tar
        chmod 644 shop3.tar
    - name: Copy image tar to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        source: "./shop3.tar"
        target: "/home/ubuntu"
        overwrite: true
        strip_components: 0
    - name: Run Docker container on EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          docker stop shop3 || true
          docker rm shop3 || true
          docker image rm gdj90/shop3:${{ github.run_number }} || true
          docker load -i shop3.tar
          docker run -d --name shop3 -p 8080:8080 \
            -v /home/ubuntu/upload:/app/upload \
            gdj90/shop3:${{ github.run_number }}